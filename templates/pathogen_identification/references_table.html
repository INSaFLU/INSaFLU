{% extends '_layouts/base.html' %}


{% load bootstrap4 %}
{% load querystring from django_tables2 %}
{% load title from django_tables2 %}
{% load trans blocktrans from i18n %}
{% load django_bootstrap_breadcrumbs %}

{% load static %}

{% block extra_messages %}
	<!-- set the messages -->
	<div class="container">
		<div id="id_messages_remove"></div>
	</div>
{% endblock %}


{% block css %}
	{% load static from staticfiles %}
		<link rel="stylesheet" href="{% static 'css/flu-web-site.css' %}" type="text/css" />
    <link rel="stylesheet" href="{% static 'css/televir_software_graph/collapsibleTree-0.1.6/collapsibleTree.css' %}" />
    <link rel="stylesheet" href="{% static 'css/reference_management.css' %}">
    <link rel="stylesheet" href="{% static 'css/televir_reference_management_panels.css' %}">

{% endblock css %}

{% block breadcrumbs %}
{{block.super}}
{% if owner %}
{% breadcrumb "Project Index" "project-index" %}
{% breadcrumb "TELEVIR Projects" "PIprojects_main"  %}
{% breadcrumb project_name "PIproject_samples" pk=project_index %}
{% breadcrumb sample_name "sample_main" pk1=project_index pk2=sample_index  %}
{% breadcrumb "References Management" "sample_references_management" pk1=sample_index %}
{% else %}
{% breadcrumb "Project Index" "project-index" %}

{% endif %}
{% endblock %}

{% block content %}


<div id="accordion1" role="tablist" aria-multiselectable="true">
  <div class="card">
      <div class="card">
          <div class="card-header" role="tab" id="headingsample">
              <div class="row">
                  <div class="col-sm" >
                      <h5 class="mb-0" >
                          <a class="collapsed" data-toggle="collapse" data-parent="#accordion" href="#collapsehead" aria-expanded="false" aria-controls="headinghead">
                              <strong>Workflows sample: {{sample_name}}</strong>
                          </a>
                      </h5>
                  </div>
                  <div class="col-sm">
                      <div class="float-right">
                          <a href={% url 'televir_sample_compound_report' pk1=project_index pk2=sample_index %} class="btn btn-primary dark"> 
                              <span class="hidden-phone"></span>Combined Report</a>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      {% if runs_number %}
      <div id="collapsehead" class="collapse" role="tabpanel" aria-labelledby="headingsample">
          <div class="card-block">
              <div style="padding: 20px">
                  
                  <div class="row">
                      <div class="col-sm-2">
                          {% for run in runs %}
                          <a href={% url 'sample_detail' pk1=run.project.pk pk2=run.sample.pk pk3=run.pk %}> Workflow report {{run.parameter_set.leaf.index}} </a>
                          <br>
                          <br>
                          {% endfor %}
                      </div>
                      {% if graph_json %}
                      <div class="col-sm-10">
                              <div id="{{graph_id}}" style="width:95%;height:250px;position:center;" class="collapsibleTree html-widget"></div>
                              <script type="application/json" data-for="{{graph_id}}">{{graph_json|safe}}</script>
                      </div>
                      <div class="col-sm-2">
                        <div class="info-icon">
                          <img src="{% static "img/pipeline_steps_classification.jpg" %}" alt="Graph Information">
                          <i class="fa fa-info-circle"></i>
                        </div>
                      </div>
                      {% endif %}
                  </div>
                  
              </div>
          </div>
      </div>
      {% endif %}
  </div>
</div>

<div id="accordion2" role="tablist" aria-multiselectable="true">
  <div class="card">
      <div class="card">
          <div class="card-header" role="tab" id="headingsample2">
              <div class="row">
                  <div class="col-sm" >
                      <h5 class="mb-0" >
                          <a class="collapsed" id="add_references_title" data-toggle="collapse" data-parent="#accordion2" href="#collapsehead2" aria-expanded="false" aria-controls="headingsample2">
                              <strong> {{ added_references_count }} Added References </strong>
                          </a>
                      </h5>
                  </div>
                  <div class="col-sm">
                    <div class="float-right">
                      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
                        Add References
                      </button>
                    </div>
                </div>
              </div>
          </div>
      </div>
      <div id="collapsehead2" class="collapse" role="tabpanel" aria-labelledby="headingsample2">
        {{ added_references_table }}
      </div>

  </div>
</div>

<div id="accordion3" role="tablist" aria-multiselectable="true">
  <div class="card">
      <div class="card">
          <div class="card-header" role="tab" id="headingPanel">
              <div class="row">
                  <div class="col-sm" >
                      <h5 class="mb-0" >
                          <a class="collapsed" id="add_panels_title" data-toggle="collapse" data-parent="#accordion3" href="#collapsePanel" aria-expanded="false" aria-controls="headingPanel">
                              <strong> {{ added_panels_count }} Added Panels </strong>
                          </a>
                      </h5>
                  </div>
                  <div class="col-sm">
                    <div class="float-right">
                      <button type="button" class="add-panels btn btn-primary" data-toggle="modal" data-target="#addPanelModal" href="{% url 'get_sample_panel_suggestions' %}" sample-id="{{ sample_index }}">
                        Add Panels
                      </button>
                    </div>
                </div>
              </div>
          </div>
      </div>
      <div id="collapsePanel" class="collapse" role="tabpanel" aria-labelledby="headingPanel">
        <div class="panel-list" data-url="{% url 'panel_references_get' %}">
          <ul id="panel-list">
            {% for panel in panels %}
            <li>
                <div class="panel-container clearfix" data-panel-id="{{ panel.id }}">
                    <a data-panel-id="{{ panel.id }}">{{ panel.name }}</a>

                    <button class="remove-panel-button btn btn-danger" data-panel-id="{{ panel.id }}" title="Remove Panel" data-toggle="modal" data-target="#removePanelModal">
                        <i class="fa fa-trash"></i>
                    </button>
                    
                    <button class="add-reference-button btn btn-primary" data-panel-id="{{ panel.id }}" data-toggle="modal" data-target="#myModal" title="Add References">
                        <i class="fa fa-plus"></i>
                    </button>

                    <span class="reference-note " data-panel-id="{{ panel.id }}">{{ panel.references_count }} </span>

                </div>
            </li>
            {% empty %}
            <li>No panels available.</li>
            {% endfor %}
        </ul>
      </div>
      </div>
  </div>
</div>

<div class="table-container">

  <div class="sidebar">
      <div class="sidebar-actions">
        <div class="sidebar-header">
          <h3> Actions </h3>
        </div>
        <div class="button-group-casing">
          <button class="btn btn-primary first-button">
            {{ deploy_metagenomics }} 
          </button>

          <button class="btn btn-primary">
            <a id="request_map_selected" href="#id_map_selected_modal" data-toggle="modal" data-target="#id_map_selected_modal" style="color: #fff;">
              <i class="fa fa-map-marker" aria-hidden="true"></i> Map Selected
            </a>
          </button>
          <button class="btn btn-primary">
            <a id="request_screening" href="#id_screening_modal" data-toggle="modal" data-target="#id_screening_modal" style="color: #fff;">
              <i class="fa fa-rocket" aria-hidden="true"></i> Deploy Screening
            </a>
          </button>
          <button class="btn btn-primary parameters-button">
            {{ meta_parameters  }}  
          </button>
        </div>
  
      </div>
  </div>
  <div class="table-content">
    {% block table %}
    <div class="table-responsive">
        <table id="table_with_check_id" check_box_all="{{ check_box_all }}" class="table table-hover table-bordered table-striped" set-check-box-values-url="{% url 'set-check-box-values' %}" {% if table.attrs %} {{ table.attrs.as_html }}{% endif %}>
          
          {% block table.thead %}
            <thead>                 
            <tr>
                <tr>
                    <th colspan="7">
                        <form method="get" action="" class="form-inline form-search pull-right">
                          {% csrf_token %}
                            <div class="pull-right form-search">
                              <input id="search_form_id" name="search_add_project_sample" type="text" class="form-control col-sm-9" placeholder="Description, Accession, Taxid"{% if search_add_project_sample %} value="{{ search_add_project_sample }}"{% endif %}>
                                <button type="submit" name="search_in_table" class="btn btn-small btn-dark"><i class="fa fa-search"></i> Search</button> 
                            </div>              
                        </form>
                    </th>                  
                </tr>
            
              <tr>
                {% for column in table.columns %}
                  {% if column.orderable %}
                      <th {{ column.attrs.th.as_html }}><a href="{% querystring table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|title }}</a></th>
                    {% else %}
                      <th {{ column.attrs.th.as_html }}>{{ column.header|title }}</th>
                    {% endif %}
                {% endfor %}
              </tr>
            </thead>
            {% endblock table.thead %}
            {% block table.tbody %}
            <tbody>
                {% for row in table.page.object_list|default:table.rows %} {# support pagination #}
                  {% block table.tbody.row %}
                  <tr class="{% cycle 'odd' 'even' %}">
                      {% for column, cell in row.items %}
                          <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                      {% endfor %}
                  </tr>
                  {% endblock table.tbody.row %}
                {% empty %}
                  {% if table.empty_text %}
                  {% block table.tbody.empty_text %}
                    <tr><td colspan="{{ table.columns|length }}">{{ table.empty_text }}</td></tr>
                  {% endblock table.tbody.empty_text %}
                  {% endif %}
                {% endfor %}
            </tbody>
            {% endblock table.tbody %}
            {% block table.tfoot %}
              <tfoot></tfoot>
            {% endblock table.tfoot %}
        </table>
    </div>
    {% endblock table %}

    {% if table.page and show_paginatior %}
    <div class="paginator">
    {% block pagination %}
      <label id="id-total-list" class="pull-right">Total references: {{ query_set_count }}</label>
        {% bootstrap_pagination table.page url=request.get_full_path %}
    {% endblock pagination %}
    </div>

    {% else %}
    <label id="id-total-list" class="pull-right">Total samples: {{ query_set_count }}</label>
    {% endif %}

    </div>

</div>

<a id="id_go_back_button" onClick="javascript:history.go(-1);"
  class="btn btn-small btn-primary dark" style="color: #fff;"><span class="hidden-phone"><i class="fa fa-arrow-left"></i> Go back</span></a>


<!-- Modal -->


<!-- The sample metagenomics submit modal -->
<div class="modal fade" id="id_deploy_metagenomics_modal">
  <div class="modal-dialog">
      <div class="modal-content">

          <!-- Modal Header -->
          <div class="modal-header alert alert-warning">
              <h4 class="modal-title-submit">Submit sample deployment</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
          </div>

          <!-- Modal body -->
          <div class="modal-body mx-auto mw-100">
              <div id="id-modal-body-deploy-metagenomics-sample" deploy-metagenomics-single-value-url="{% url 'deploy_metagenomics_televir_project_sample' %}">
                  <label id="id-label-deploy-metagenomics" class="col-form-label">Folder Name</label>
              </div>
          </div>
          <!-- Modal footer -->
          <div class="modal-footer" id="id-modal-footer-remove">
              <button id="id-deploy-metagenomics-button" type="button" class="btn btn-primary" data-dismiss="modal">Deploy</button>
              <button id="id-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal"
                  aria-hidden="true">Cancel</button>
          </div>
      </div>
  </div>
</div>


<!-- The refrence search -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Add References</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-sm-9">          <!-- Your search form code here -->
            <form id="reference-search-form">
              <div class="input-group">
                <input id="search-input" type="text" class="form-control" placeholder="Description, Accid, Taxid">
                <div class="input-group-append">
                  <button type="submit" class="load-content btn btn-primary" href="{% url 'filter_reference_table' %}">Search</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div id="reference_table_div" class="table-container">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="submit-button" href="{% url 'add_references_to_sample' %}" reload_ref= "{% url 'added_reference_table' %}">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- The add panel modal -->
<div class="modal fade" id="addPanelModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Add Panels</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="panel-list-modal" data-url="{% url 'panel_references_get' %}">
          <ul id="panel-list-modal">
          </ul> 
        </div>    
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="panel-submit-button" href="{% url 'add_panels_to_sample' %}">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- The remove panel modal -->
<div class="modal fade" id="removePanelModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="myModalLabel">Remove Panel</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="id-modal-body-remove-panel" remove-panel-single-value-url="{% url 'remove_added_panel' %}" data-csrf= "{{ csrf_token }}">
          <label id="id-label-remove-panel" class="col-form-label">Folder Name</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="remove-panel-final-button" href="{% url 'remove_added_panel' %}">Remove</button>
      </div>
    </div>
  </div>
</div>

<!-- The remove modal -->
<div class="modal fade" id="id_remove_modal">
	<div class="modal-dialog">
		<div class="modal-content">

			<!-- Modal Header -->
			<div class="modal-header alert alert-warning">
				<h4 class="modal-title-remove">Remove a Reference</h4>
				<button type="button" class="close" data-dismiss="modal">&times;</button>
			</div>

			<!-- Modal body -->
			<div class="modal-body mx-auto mw-100">
				<div id="id-modal-body-remove-sample" sample_id="{{ sample_index }}" remove-single-value-url="{% url 'remove_added_reference' %}" data-csrf= "{{ csrf_token }}">
					<label id="id-label-remove" class="col-form-label">Folder Name</label>
				</div>
			</div>
			<!-- Modal footer -->
			<div class="modal-footer" id="id-modal-footer-remove">
				<button id="id-remove-button" type="button" class="btn btn-primary" data-dismiss="modal">Remove</button>
				<button id="id-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal"
					aria-hidden="true">Cancel</button>
			</div>
		</div>
	</div>
</div>


<!-- The map selected modal -->
<div class="modal fade" id="id_map_selected_modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header alert alert-warning">
        <h4 class="modal-title-map">Map selected references</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div class="modal-body mx-auto mw-100">
        <div id="id-modal-body-map-selected" sample_id="{{ sample_index }}" map-selected-single-value-url="{% url 'map_selected_references' %}" data-csrf= "{{ csrf_token }}">
          <label id="id-label-map-selected" class="col-form-label">Folder Name</label>
        </div>
      </div>
      <!-- Modal footer -->
      <div class="modal-footer" id="id-modal-footer-map-selected">
        <button id="id-map-selected-button" type="button" class="btn btn-primary" data-dismiss="modal">Map</button>
        <button id="id-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal"
          aria-hidden="true">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- The screening modal -->
<div class="modal fade" id="id_screening_modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header alert alert-warning">
        <h4 class="modal-title-screening">Deploy screening</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div class="modal-body mx-auto mw-100">
        <div id="id-modal-body-screening" sample_id="{{ sample_index }}" screening-single-value-url="{% url 'deploy_screening_televir_project_sample' %}" data-csrf= "{{ csrf_token }}">
          <label id="id-label-screening" class="col-form-label">Folder Name</label>
        </div>
      </div>
      <!-- Modal footer -->
      <div class="modal-footer" id="id-modal-footer-screening">
        <button id="id-screening-button" type="button" class="btn btn-primary" data-dismiss="modal">Deploy</button>
        <button id="id-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal"
          aria-hidden="true">Cancel</button>
      </div>
    </div>
</div>


{% endblock content %}

{% block js %}

{% load static from staticfiles %}
<!-- Custom scripts for all pages-->
<script type="text/javascript" src="{% static 'js/check-box-general.js' %}"></script>
<script type="text/javascript" src="{% static 'js/graph_televir/htmlwidgets-1.6.2/htmlwidgets.js' %}"></script>
<script type="text/javascript" src="{% static 'js/graph_televir/d3-4.10.2/d3.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/graph_televir/collapsibleTree-binding-0.1.7/collapsibleTree.js' %}"></script>
<script type="text/javascript" src="{% static 'js/televir_projects/remove_added_reference.js' %}"></script>

<script>
  $('#request_map_selected').on("click", function(e){
    attr= $(this).attr('id');
    
    $('#id-label-map-selected').text('Map selected references?');
    
  });

  $('#request_screening').on("click", function(e){
    attr= $(this).attr('id');
    
    $('#id-label-screening').text('Deploy Screening?');
    
  });


  // deploy screening
  $('#id-screening-button').on('click', function() {

    var url= $('#id-modal-body-screening').attr("screening-single-value-url");
    var csrf_token = $('#id-modal-body-screening').attr('data-csrf'); 
    console.log(csrf_token);

    $.ajax({
      type: 'POST',
      url: url,
      data: {
        'csrfmiddlewaretoken': csrf_token,
        'sample_id': '{{ sample_index }}',
      },
      success: function(data) {
        console.log(data);
        if (data['is_ok'] == true && data['is_deployed'] == true) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
            'Screening deployed. ' + data['message'] +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

        } else if (data['is_ok']) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'Screening not deployed. Check settings.' + data['message'] +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

            // drop modal
            $('#id_screening_modal').modal('hide');
          
        } else if (data['is_ok'] == false) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'Screening not deployed. Check Parameters.' +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

            // drop modal
            $('#id_screening_modal').modal('hide');
        }
      }
    })
  });


  $('#id-map-selected-button').on('click', function() {

    var url= $('#id-modal-body-map-selected').attr("map-selected-single-value-url");
    var csrf_token = $('#id-modal-body-map-selected').attr('data-csrf'); 
    console.log(csrf_token);

    var checkedRows = [];
    $('.class-ref-checkbox:checked').each(function() {
      // collect ids of checked rows

      var ref_id= $(this).attr('ref_id');

      checkedRows.push(ref_id);
    });

    console.log(checkedRows);

    $.ajax({
      type: 'POST',
      url: url,
      data: {
        'csrfmiddlewaretoken': csrf_token,
        'sample_id': '{{ sample_index }}',
        'reference_ids': checkedRows
      },
      success: function(data) {
        console.log(data);
        if (data['is_ok'] == true && data['is_deployed'] == true) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
            'References mapping deployed. ' + data['message'] +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

        } else if (data['is_empty'] == true) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'No references were selected. ' + data['message'] +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

            // drop modal
          
        } else if (data["is_already_mapped"] == true) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'Selected and added references already mapped.' +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');
  
        } else if (data['is_ok']) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'References were not mapped. ' + data['message'] +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

            // drop modal
            $('#id_map_selected_modal').modal('hide');

        } else if (data['is_ok'] == false) {
          $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
            'The references were not mapped.' +
            '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
            '</div>');

            // drop modal
            $('#id_map_selected_modal').modal('hide');
        } 
      }
    })
  });

</script>

<script>


  var load_panels = function(sample_id, load_url, target, load = false, suggest= true) {
    // var url = '{% url "panel_list" %}';
    console.log('url:', load_url);
    $.ajax({
        url: load_url,
        method: 'GET',
        data: {
            'sample_id': sample_id
        },
        success: function(data) {
            // Clear the panel list
            console.log('data:', data);
            var panelList = document.querySelector(target);
            console.log('panelList:', panelList);
            while (panelList.firstChild) {
                panelList.removeChild(panelList.firstChild);
            }

            // Check if the panels array is empty
            if (data.panels.length === 0) {
                var li = document.createElement('li');
                li.textContent = 'No panels available.';
                panelList.appendChild(li);

            } else {
                // Add the new panels to the list
                data.panels.forEach(function(panel) {
                    var li = document.createElement('li');
                    // div 

                    var div = document.createElement('div');
                    div.className = 'panel-container clearfix';
                    div.setAttribute('data-panel-id', panel.id);

                    var a = document.createElement('a');
                    a.className = 'panel-link';
                    a.href = '#';
                    a.setAttribute('data-panel-id', panel.id);
                    a.textContent = panel.name;
                    
                    var addButton = document.createElement('button');
                    addButton.className = 'add-reference-button btn btn-primary';
                    addButton.setAttribute('data-panel-id', panel.id);
                    addButton.setAttribute('data-toggle', 'modal');
                    addButton.setAttribute('data-target', '#myModal');
                    var icon = document.createElement('i');
                    icon.className = 'fa fa-plus';
                    addButton.appendChild(icon);
                    
                    var removeButton = document.createElement('button');
                    removeButton.className = 'remove-panel-button btn btn-danger';
                    removeButton.setAttribute('data-panel-id', panel.id);
                    removeButton.setAttribute('data-toggle', 'modal');
                    removeButton.setAttribute('data-target', '#removePanelModal');
                    var icon = document.createElement('i');
                    icon.className = 'fa fa-trash';
                    removeButton.appendChild(icon);
                    
                    var refnumber_span = document.createElement('span');
                    refnumber_span.className = 'reference-note';
                    refnumber_span.textContent = panel.references_count;
                    refnumber_span.setAttribute('data-panel-id', panel.id);

                    var panel_checkbox = document.createElement('input');
                    panel_checkbox.type = 'checkbox';
                    panel_checkbox.className = 'panel-checkbox';
                    panel_checkbox.setAttribute('data-panel-id', panel.id);

                    if (load){
                      div.appendChild(removeButton);
                    }
                                        
                    div.appendChild(a);

                    if (suggest){
                      div.appendChild(panel_checkbox);
                    }
                    div.appendChild(refnumber_span);

                    li.appendChild(div);
                    panelList.appendChild(li);
                    
                });

            // reload the connects            
            // clear messages 
            prep_loads();
            //$('#id_messages_remove').empty();
            }
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
  }

  var prep_loads= function() {
    $('.remove-panel-button').click(function () {
      var panel_id = $(this).attr('data-panel-id');
      console.log('panel_id:', panel_id);
      $('#id-modal-body-remove-panel').attr('data-panel-id', panel_id);
      $('#id-label-remove-panel').text('Remove panel ' + panel_id + '?');
    });

    $('#remove-panel-final-button').click(function (){
      console.log('remove-panel-final-button');
      var url = $('#id-modal-body-remove-panel').attr('remove-panel-single-value-url');
      var csrf_token = $('#id-modal-body-remove-panel').attr('data-csrf');
      var panel_id = $('#id-modal-body-remove-panel').attr('data-panel-id');
      console.log(url);
      $.ajax({
        type: 'POST',
        url: url,
        data: {
          'csrfmiddlewaretoken': csrf_token,
          'panel_id': panel_id,
        },
        success: function(data) {
          console.log(data);
          if (data['is_ok']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
              'Panel successfully removed' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              load_panels('{{ sample_index }}', '{% url "get_sample_panels" %}', '.panel-list ul', true, false);
              // drop modal
              $('#removePanelModal').modal('hide');
          } else if (data['is_error']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The panel was not removed.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              // drop modal
              $('#removePanelModal').modal('hide');
          }
        }
    });
    });
  }

  $(document).ready(function() {

    // load panels
    load_panels('{{ sample_index }}', '{% url "get_sample_panels" %}', '.panel-list ul', true, false);
    prep_loads();
    $('.add-panels').click(function() {
      var url= $(this).attr('href');
      var sample_id = $(this).attr('sample-id');
      console.log('sample_id:', sample_id);
      console.log('url:', url);
      load_panels(sample_id, url, '.panel-list-modal ul', false, true);
    });

    $('#remove-panel-final-button').click(function (){
      console.log('remove-panel-final-button');
      var url = $('#id-modal-body-remove-panel').attr('remove-single-value-url');
      var csrf_token = $('#id-modal-body-remove-panel').attr('data-csrf');
      var panel_id = $('#id-modal-body-remove-panel').attr('data-panel-id');

      $.ajax({
        type: 'POST',
        url: url,
        data: {
          'csrfmiddlewaretoken': csrf_token,
          'panel_id': panel_id,
        },
        success: function(data) {
          console.log(data);
          if (data['is_ok']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
              'Panel successfully removed' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              load_panels('{{ sample_index }}', '{% url "get_sample_panels" %}', '.panel-list ul', true, false);
              // drop modal
              $('#removePanelModal').modal('hide');
          } else if (data['is_error']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The panel was not removed.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              // drop modal
              $('#removePanelModal').modal('hide');
          }
        }
    });
    });

    $('#panel-submit-button').click(function () {
      var url = $(this).attr('href');
      console.log('url:', url);
      var checkedRows = [];
      $('.panel-checkbox:checked').each(function() {
        // collect ids of checked rows
        var panel_id= $(this).attr('data-panel-id');
        checkedRows.push(panel_id);
      });
      console.log('checkedRows:', checkedRows);
      $.ajax({
        type: 'POST',
        url: url,
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'sample_id': '{{ sample_index }}',
          'panel_ids': checkedRows
        },
        success: function(data) {
          if (data['is_ok']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
              'Panels successfully added' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              load_panels('{{ sample_index }}', '{% url "get_sample_panels" %}', '.panel-list ul', true, false);
              // clear selection 
              $('.panel-checkbox').prop('checked', false);
              // drop modal
              $('#addPanelModal').modal('hide');
          } else if (data['is_error']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The panels were not added.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              // drop modal
              $('#addPanelModal').modal('hide');
          } else if (data['is_empty']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'No panels were selected.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              // drop modal
              $('#addPanelModal').modal('hide');
          }
        }
      });
    });

    $('#submit-button').click(function() {
      var url = $('#submit-button').attr('href');
      var reload_url = $('#submit-button').attr('reload_ref');
      var checkedRows = [];
      $('.reference-checkbox:checked').each(function() {
        // collect ids of checked rows

        var ref_id= $(this).attr('ref_id');

        checkedRows.push(ref_id);
      });
  
      // Process the checked rows
      // Add your processing logic here
      // send row ids to server using .ajax
      $.ajax({
        type: 'POST',
        url: url,
        data: {
          'csrfmiddlewaretoken': '{{ csrf_token }}',
          'sample_id': '{{ sample_index }}',
          'reference_ids': checkedRows
        },
        success: function(data) {
          if (data['is_ok']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
              'References successfully added' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              // reload table
              $.ajax({
                url: reload_url,
                type: 'GET',
                data: {
                    sample_id: '{{ sample_index }}',
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function (data) {

                  $('#collapsehead2').html(data.my_content);
                  $('#reference_table_div').html(data.empty_content);
                  $('#add_references_title').html(
                    "<strong>" + data.references_count + " Added References </strong>"
                  );
                  // empty #search-input
                  $('#search-input').val('');
                }
              }
              )
              // clear selection 
              $('.reference-checkbox').prop('checked', false);
              
              
              // drop modal
              $('#myModal').modal('hide');

          } else if (data['is_error']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The references were not added.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');

              // drop modal
              $('#myModal').modal('hide');
          } else if (data['is_empty']) {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'No references were selected.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');

              // drop modal
              
          }
          
        }
      })

    });
  });

  var loadThisContent = function (event) {
    event.preventDefault();
    var btn = $(this);
    var url = btn.attr("href");
    console.log($('#search-input').val());
    console.log(url);
    $.ajax({
        url: btn.attr("href"),
        type: 'GET',
        data: {
            search_add_project_reference: $('#search-input').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function (data) {

          $('#reference_table_div').html(data.my_content);
          
          if (data["references_count"] > 0){

          var selectAllCheckbox = document.getElementById('Select-All-Checkbox-Modal');

          var referenceCheckboxes = document.getElementsByClassName('reference-checkbox');

     
          selectAllCheckbox.addEventListener('change', function() {
            for (var i = 0; i < referenceCheckboxes.length; i++) {
              referenceCheckboxes[i].checked = this.checked;
            }
          });
          }
        }
    }
    )
  };
  $('.load-content').on('click', loadThisContent);

  $(document).on("click", "a", function (e) {

    if ($(this).attr("id") === 'deploy_metagenomics_modal'){
        var ref_name = $(this).attr('ref_name');
        var sample_pk = $(this).attr('pk');
  
        $('#id-label-deploy-metagenomics').text('Deploy metagenomics combined analysis for sample \'' + ref_name + '\'?');
        $('#id-modal-body-deploy-metagenomics-sample').attr('sample_id', sample_pk);
        $('#id-modal-body-deploy-metagenomics-sample').attr('ref_name', ref_name);
    }
    
  });
  
  $('#id-deploy-metagenomics-button').on('click', function(){
    url= $('#id-modal-body-deploy-metagenomics-sample').attr("deploy-metagenomics-single-value-url");
    sample_id = $('#id-modal-body-deploy-metagenomics-sample').attr('sample_id');
  
    $.ajax({
        url: url, 
        type: 'POST',
        data: {
            sample_id : sample_id,
            csrfmiddlewaretoken: '{{ csrf_token }}',
        }, // data sent with the post request
        success: function(data) {

          
          if (data['is_ok'] === true && data['is_deployed'] === true){
              /// add message with informaton
              $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
              'The sample \'' + $('#id-modal-body-deploy-metagenomics-sample').attr('ref_name') + '\' was successfully deployed.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
              location.reload() 
          }
          else if (data['is_ok'] === true && data['is_deployed'] === false){
              /// add message with informaton
              $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The sample \'' + $('#id-modal-body-deploy-metagenomics-sample').attr('ref_name') + '\' was not deployed. Check if metagenomics settings are correctly set.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
          }
          else{
              /// add message with informaton
              $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'The sample \'' + $('#id-modal-body-deploy-metagenomics-sample').attr('ref_name') + '\' was not deployed. Check if metagenomics settings are correctly set.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
          }
        }
    })
  }
  )
  $(document).on("click", "a", function (e) {
    if ($(this).attr("id") == "add_teleflu_reference") {
      e.preventDefault();
      var url = $(this).attr("url");
      var ref_id = $(this).attr("ref_id");
      console.log(ref_id);
      $.ajax({
        url: url,
        type: 'POST',
        data: {
          ref_id: ref_id,
          user_id: '{{ user.id }}',
          csrfmiddlewaretoken: '{{ csrf_token }}',
        },
        success: function(data) {
          console.log(data);
          if (data['is_ok']) {
            
            if (data['exists']) {
              $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
                'Teleflu Reference already exists.' +
                '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                '</div>');
            } else {
              $('#id_messages_remove').append('<div class="alert alert-dismissible alert-success">' +
                'Teleflu Reference added.' +
                '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
                '</div>');
            }

          } else {
            $('#id_messages_remove').append('<div class="alert alert-dismissible alert-warning">' +
              'Teleflu Reference not added.' +
              '<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>' +
              '</div>');
          }

        }
      })
    }
  }
  );

</script>

{% endblock %}


