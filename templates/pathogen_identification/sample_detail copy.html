{% extends '_layouts/base.html' %}
{% load render_table from django_tables2 %}
{%load html_tags%}

{% load static %}
{%load report_colors %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/base.css' %}" />
<link rel="stylesheet" href="{% static 'css/result_table.css' %}" />
{% endblock css %}


{% block content %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js">
</script>

<style>
    #left {
        border-collapse: collapse;
        color: #2E2E2E;
        border: #A4A4A4;
    }

    #left tbody tr:hover {
        background-color: #F2F2F2;
    }

    #left tbody tr {
        display: none;
    }

    #left tr.parent {
        display: table-row;
    }

    #left tr.open {
        display: table-row;
    }

    a:link {
        color: darkblue;
        background-color: transparent;
        text-decoration: none;
    }

    a:visited {
        color: blueviolet;
        background-color: transparent;
        text-decoration: none;
    }

    a:hover {
        color: blue;
        background-color: transparent;
        text-decoration: underline;
    }

    a:active {
        color: cornflowerblue;
        background-color: transparent;
        text-decoration: underline;
    }

    #left img {
        width: 100%;
        display: block;
        width: 100%;
        colspan: 100%;
    }

    .modebar {
        display: none !important;
    }

    .row {
        border: 4px solid;
        border-radius: 8px;
        padding: 15px;
        border-color: #b0b0b07d;
    }
</style>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h3> Pre-Processing </h3>
            {% if enrichment %}
            <p> Viral enrichment was performed using <strong>{{ software.HD }}</strong>. </p>
            <p> {{ input }} input reads. {{post_input}} ( {{post_percent}}%)
                remaining after enrichment. </p>
            {% elif depletion %}
            <br>
            <p> The following table shows the results of the pre-processing. </p>
            <p> The pre-processing is done in the following order: </p>
            <br>
            {% else %}
            <br>
            <p> No pre-processing step was performed </p>
            {% endif %}
            {% if sift.preproc %}
            <p> SIFT was performed on the pre-processed reads. </p>
            {% endif %}
        </div>
    </div> <!-- end row -->
    <br>
    <div class="row">
        <div class="col-md-12">
            <h3>Assembly</h3>
            {% if assembly.performed %}
            <p> Assembly was run using the software <strong>{{assembly.assembly_soft}}</strong>. </p>
            <p> Assembled contigs were filtered for a minimum size of {{assembly.assembly_trim}} bp. </p>
            <p> After filtering, {{assembly.assembly_number}} contigs remained, of sizes ranging between
                {{assembly.assembly_min}} bp and {{assembly.assembly_max}} bp (mean {{assembly.assembly_mean}}) </p>

            {% endif %}
        </div>
    </div> <!-- end row -->
    <br>
    <div class="row">
        <div class="col-md-12">
            <h3> Reference identification</h3>
            <p> Assembled contigs were classified using the software
                <strong>{{class_assembly.assembly_class_soft}}</strong>. </p>
            {% if class_assembly.assembly_class_number > 0 %}
            <p style=padding-left:3em> &bull; {{class_assembly.assembly_class_number}} accessions were identified with
                at least
                {{class_assembly.assembly_min_hit}} hit(s).</p>
            {% else %}
            <p style=padding-left:3em> &bull; {{class_assembly.assembly_class_number}} accessions were identified. </p>
            {% endif %}
            <br>
            <p> Reads were classified using the software <strong>{{class_reads.reads_class_soft}}</strong> </p>
            {% if class_reads.reads_class_number > 0 %}

            <p style=padding-left:3em> &bull; {{class_reads.reads_class_number}} accessions were identified with at
                least
                {{class_reads.reads_class_min_hit}} hit(s). </p>
            {% else %}
            <p style=padding-left:3em> &bull; {{class_reads.reads_class_number}} accessions were identified. </p>
            {% endif %}
            {% if sift.remap %}
            <br>
            <p> SIFT was performed on the classified reads and contigs. </p>
            {% endif %}
            {% if merged.performed %}
            <br>
            <p> After merging, a total of {{merged.merged_number}} taxids were selected for remapping against. </p>
            <p style=padding-left:3em> references were collected from the data bases: <em>{{merged.files}}</em>. </p>
            {% else %}
            <br>
            <p> No merging was performed. </p>
            {% endif %}

        </div>
    </div> <!-- end row -->
    <br>
    <div class="row">
        <div class="col-md-12">
            <h3> Remapping </h3>
            <p> Remapping was performed using the software <strong>{{remap.remap_soft}}</strong>. </p>
            <p> Of the references identified, {{merged.merged_number}} were found in our databases. </p>
            <p style=padding-left:4em> from these, {{remap.success}} successful alignments were produced.
            </p>
            <p> Results are shown for a minimum coverage of {{remap.cov_min}}X and a maximum coverage of
                {{remap.cov_max}}X. </p>
            <p> The following table shows the results of the remapping onto identified references. </p>

        </div>
    </div> <!-- end row -->
    </br>
</div>
</div>

<div class="container">
    <div class="container">
        <p id="toggle">
            <button> Table </button>
            <button> List </button>
        </p>
    </div>
    <div class="container" id="right">
        {% for value in final_data.itertuples %}
        <div class="card">
            <div class="container">
                <div class="card-body">

                    <h3 class="card-title">{{value.description}}</h3>
                    <p class="card-text">
                        taxid: {{ value.taxid }}, ID: {{ value.ID }},
                    </p>
                    <p class="card-text">
                        source: {{ value.refdb }}
                    </p>

                </div>
                <br>
            </div>
        </div>
        <br>

        {% endfor %}
    </div>

    <div class="container" id="left">
        <table class="styled-table" id="sample_report">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Taxid</th>
                    <th>accID</th>
                    <th>Cov (%)</th>
                    <th>Depth</th>
                    <th>DepthC</th>
                    <th>Mapped reads</th>
                    <th>ref_prop (%)</th>
                    <th>mapped_prop (%)</th>
                    <th>success</th>
                </tr>
            </thead>
            <tbody>
                {% for value in final_report %}
                <tr class="parent">
                    <td data-title="Description"><a href="#" id="plotShow">{{value.description}}</a></td>
                    <td data-title="Taxid">{{value.taxid}}</td>
                    <td data-title="accID">{{value.ID }}</td>
                    <td data-title="Cov" style="{{ value.coverage|color_code }}">
                        {{value.coverage|round}}</td>
                    <td data-title="Depth" style="{% depth_color value.Hdepth report_references.max_depth %}">
                        {{value.Hdepth|round}}</td>
                    <td data-title="DepthC" style="{% depth_color value.HdepthR report_references.max_depthR %}">
                        {{value.HdepthR|round}}</td>
                    <td data-title="Mapped reads" style="{% depth_color value.mapped report_references.max_mapped %}">
                        {{value.mapped|round}}</td>
                    <td data-title="ref_prop" style="{% depth_color value.ref_prop report_references.max_prop %}">
                        {{value.ref_prop|round_to_int}}</td>
                    <td data-title="mapped_prop" style="{% depth_color value.mapped report_references.max_mapped %}">
                        {{value.mapped_prop|round_to_int}}</td>
                    <td data-title="success" style="{{ value.success|success_code }}">
                        {{value.success_verbose}}</td>
                </tr>
                <tr>
                    <td align="center">
                        <p>{{value.refdb|strip_ext}}</p>
                    </td>
                    <td align="center">
                        <a href={{value.ID|link_ncbi}}>{{value.ID}}</a>
                    </td>
                    <td align="center">
                        <p>{{value.contig_length}}</p>
                    </td>

                </tr>
                <tr>
                    <td colspan="1" align="center">
                        <p>Mapping Coverage</p>
                    <td colspan="8" align="center">
                        <img src="{% static 'ref_coverage/' %}{{ value.covplot }}"="200"="250" alt="">
                    </td>
                    <td colspan="1" align="center">
                        <a href="{% url 'igv_app' %}"> IGV </a>
                    </td>
                </tr>

                <tr>
                    <td colspan="1" align="center">
                        <p>Asembly to reference dotplot</p>
                    <td colspan="8" align="center">
                        <img src="{% static 'refa_dotplots/' %}{{ value.refa_dotplot }}"="200"="250" alt="">
                    </td>
                    <td colspan="1" align="center">
                        <a href={% url 'scaffold_remap' sample=sample run=run_name reference=value.simple_id %}>Sample
                            remap</a>
                    </td>
                </tr>

                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
    document.getElementById("sample_report").addEventListener("click", function (e) {
        if (e.target.tagName === "A" && e.target.id === "plotShow") {
            e.preventDefault();
            var row = e.target.parentNode.parentNode;
            while ((row = nextTr(row)) && !/\bparent\b/.test(row.className))
                toggle_it(row);
        }
    });

    function nextTr(row) {
        while ((row = row.nextSibling) && row.nodeType != 1);
        return row;
    }

    function toggle_it(item) {
        if (/\bopen\b/.test(item.className))
            item.className = item.className.replace(/\bopen\b/, " ");
        else
            item.className += " open";
    }
</script>

<script>
    $(function () {
        $('#toggle > button').click(function () {
            var ix = $(this).index();

            $('#left').toggle(ix === 0);
            $('#right').toggle(ix === 1);
        });

    });

    var desktopBtn = $("#desktop");
    var mobileBtn = $("#mobile");
    var body = $('body');

    desktopBtn.on('click', function () {
        body.addClass('large-screen');
        togglePrimaryButtonStyle($(this));
    })

    mobileBtn.on('click', function () {
        body.removeClass('large-screen');
        togglePrimaryButtonStyle($(this));
    })

    function togglePrimaryButtonStyle(el) {
        var sibling = el.parent('.btn-group').siblings('.btn-group').find('.btn');
        el.addClass('btn-primary');
        sibling.removeClass('btn-primary').addClass('btn-default');
    }
</script>

{% endblock content %}