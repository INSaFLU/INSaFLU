{% extends '_layouts/base.html' %}

{% load bootstrap4 %}
{% load querystring from django_tables2 %}
{% load title from django_tables2 %}
{% load trans blocktrans from i18n %}
{% load django_bootstrap_breadcrumbs %}
{% load static %}


{% block extra_messages %}
	<!-- set the messages -->
	<div class="container">
		<div id="id_messages_remove"></div>
	</div>
{% endblock %}

{% block breadcrumbs %}
{{block.super}}
{% breadcrumb "Project Index" "project-index" %}
{% breadcrumb "TELEVIR Projects" "PIprojects_main"  %}
{% breadcrumb project_name "PIproject_samples"  pk=project_index  %}
{% breadcrumb sample_name "" %}
{% endblock %}


{% block content %}

<style>
    .modal-title-description {
        font-size: 18px;
        color: #666;
        display: block;
    }

    .workflow-container {
        border: 1px solid #eee; /* Even lighter gray */
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        border-radius: 5px;
        background-color: #f9f9f9; /* Subtle background color */
    }
    .workflow-name {
        margin-left: 10px;
        margin-right: 20px;
        align-self: center;
    }
    .outer-container {
        margin-bottom: 20px; /* Adjust as needed */
    }
    
    .step-circle {
        display: center;
        float: right;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        line-height: 40px; /* Equal to the height */
        text-align: center;
        background-color: #ccc;
        margin-right: 10px;
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
        align-items: center;
    }

    .software_off {
        background-color: #ccc;
    }

    .software_on {
        background-color: #007bff;
    }

    .workflow-title {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px;
        background-color: #f5f5f5; /* Light gray background */
        border-radius: 5px;
        margin-bottom: 0px;
        margin-right: 20px;
    }
    
    .workflow-name {
        font-size: 1.2em;
        font-weight: bold;
        width: 120px;

    }
    .step-container {
        display: flex;
        justify-content: flex-start; /* Align items to the start of the container */
        align-items: center;
        padding: 5px;
        background-color: #f5f5f5; /* Light gray background */
        border-radius: 5px;
        width: 60%;
    }
    
    .parameters-container {
        border-radius: 5px;
        background-color: #e0e0e0; /* Light gray background */
        transition: opacity 0.5s ease-in-out, width 0.5s ease-in-out;
        opacity: 0;
        max-width: 0;
        overflow: hidden;
        white-space: nowrap; /* Prevent the text from wrapping */
    }

    .parameters-container.visible {
        padding: 5px;
        padding-left: 10px;
        padding-right: 10px;
        margin-right: 10px; /* Adjust as needed */
        margin-left: 10px; /* Adjust as needed */
    }
    .modal-dialog {
        max-width: 90%; /* Adjust as needed */
    }

    .modal-body {
        margin-left: 10px;
    }

    .workflow-mapped {
        float: right;
        align-self: center;
        background-color: #b3b3b3;
        border: none;
        color: #000;
        text-align: center;
        text-decoration: none;
        margin: 0px 5px;
        margin-right: 10px;
        padding: 8px 8px;
        border-radius: 5px;
        font-size: 14px;
        font-weight: bold;
        font-family: Arial, sasns-serif;
    }

</style>


<div class="outer-container">
    <button id="open-modal-button" type="button" class="btn btn-primary" data-toggle="modal" data-target="#id_workflow_modal">
        Add Workflow
    </button>
    <br>
    <br>
    <h3 class="title">Workflow List</h3>
    <div id="workflow-list">
        {% for workflow in mapping_workflows %}
            <div class="workflow-container">
                <div class="workflow-title">
                    <span class="workflow-name">Workflow {{ workflow.node }}</span>
                </div>
                <div class="step-container">

                {% for step in workflow.modules %}
                    <span class="step-circle {{ step.available }}" title="{{ step.module }}" data-parameters="{{ step.parameters }}" onclick="showParameters(this)">{{ step.short_name }}</span>
                    <div class="parameters-container" ></div>
                {% endfor %}
                </div>
                
                <div class="workflow-info clearfix">
                    <span class="workflow-mapped" >{{ workflow.refs_mapped }} </span>
                </div>

            </div>
        {% endfor %}
    </div>

</div>
<div class="table-container">

    {% if insaflu_projects_exist %}
    <h3 class="table-title"> Insaflu  </h3>
    
    <div class="table-responsive">
        <table class="table table-hover table-bordered table-striped" {% if insaflu_table.attrs %}z
            {{ insaflu_table.attrs.as_html }}{% endif %}>
            <thead>
                <tr>
                    {% for column in insaflu_table.columns %}
                    {% if column.orderable %}
                        <th {{ column.attrs.th.as_html }}><a href="{% querystring insaflu_table.prefixed_order_by_field=column.order_by_alias.next %}">{{ column.header|title }}</a></th>
                    {% else %}
                        <th {{ column.attrs.th.as_html }}>{{ column.header|title }}</th>
                    {% endif %}
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in insaflu_table.page.object_list|default:insaflu_table.rows %} {# support pagination #}
                  {% block insaflu_table.tbody.row %}
                  <tr id="row_{{ row.record.id }}" class="{% cycle "odd" "even" %}">
                    {% for column, cell in row.items %}
                      <td {{ column.attrs.td.as_html }}>{{ cell }}</td>
                    {% endfor %}
                  </tr>
                  {% endblock insaflu_table.tbody.row %}
                {% empty %}
                  {% if insaflu_table.empty_text %}
                  {% block insaflu_table.tbody.empty_text %}
                      <tr><td colspan="{{ insaflu_table.columns|length }}">{{ insaflu_table.empty_text }}</td></tr>
                  {% endblock insaflu_table.tbody.empty_text %}
                  {% endif %}
                {% endfor %}
            </tbody>
            <tfoot></tfoot>
        </table>
    </div>
    {% endif %}

    <a href="javascript:history.go(0)" class="btn btn-small btn-primary dark"><i class="fa fa-refresh"></i> Refresh</a>

</div>


<!-- The sample submit Modal -->
<div class="modal fade" id="id_workflow_modal">
	<div class="modal-dialog">
		<div class="modal-content">

			<!-- Modal Header -->
			<div class="modal-header alert alert-warning">
                <h4 class="modal-title-submit">Available Workflow List</h4>
			</div>
            <div class="modal-body">

            <div id="workflow-list">
                {% for workflow in workflows %}
                    <div class="workflow-container">
                        <button class="add-to-project-button" onclick="addToProject('{{ workflow.pk }}', '{{project_index}}')" url="{% url 'add_workflow_to_project' %}" csrf = "{{ csrf_token }}" >Add to project</button>
                        <div class="workflow-title">
                            <span class="workflow-name">Workflow {{ workflow.node }}</span>
                        </div>
                        <div class="step-container">

                        {% for step in workflow.modules %}
                            <span class="step-circle {{ step.available }}" title="{{ step.module }}" data-parameters="{{ step.parameters }}" onclick="showParameters(this)">{{ step.short_name }}</span>
                            <div class="parameters-container" ></div>
                        {% endfor %}
                        </div>

                    </div>
                {% endfor %}
            </div>
			<!-- Modal footer -->
			<div class="modal-footer" id="id-modal-footer-remove">
				<button id="id-cancel-button" type="button" class="btn btn-secondary" data-dismiss="modal"
					aria-hidden="true">Cancel</button>
			</div>
		</div>
	</div>
</div>

{% endblock content %}

{% block js %}

{% load static from staticfiles %}

<script>


    function showParameters(element) {
        var parameters = element.getAttribute('data-parameters');
        var parametersContainer = element.nextElementSibling;
    
        // If the parameters are already displayed, hide them
        if (parametersContainer.style.opacity == 1) {
            parametersContainer.style.opacity = 0;
            parametersContainer.style.maxWidth = '0';
            parametersContainer.classList.remove('visible');
        }
        // Otherwise, display the parameters
        else {
            parametersContainer.innerHTML = parameters;
            parametersContainer.style.opacity = 1;
            parametersContainer.style.maxWidth = '1000px'; // Adjust this value as needed
            parametersContainer.classList.add('visible');
        }
    }

    var addToProject = function (workflow, project_id) {
        var url = $('.add-to-project-button').attr('url');
        var csrf= $('.add-to-project-button').attr('csrf');

        var data = {
            'leaf_id': workflow,
            'project_id': project_id,
            'csrfmiddlewaretoken': csrf,
        };
        console.log(url, csrf)
        $.ajax({
            type: "POST",
            url: url,
            data: data,
            success: function (data) {
                if (data["is_ok"] === true) {
                    alert('Workflow added to project');
                    location.reload();
                } else if (data["exists"] === true) {
                    alert('Workflow already exists in project');
                } else {
                    alert('Error adding workflow to project');
                }
            }
        });
    }

</script>

{% endblock js %}
